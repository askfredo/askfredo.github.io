#!/bin/bash
# A script to manage Folding@Home client installations and operations.

# Initialize control variable
stop=0

# Function to install FAHClient
install_fahclient() {
    wget -q https://download.foldingathome.org/releases/public/release/fahclient/debian-stable-64bit/v7.6/fahclient_7.6.21_amd64.deb
    sudo DEBIAN_FRONTEND=noninteractive dpkg -i fahclient_7.6.21_amd64.deb
}

# Function to remove FAHClient and associated files
remove_fahclient() {
    sudo dpkg -P FAHClient
    rm -r /content/work/client.db log.txt cores work
    echo "Removed FAHClient and related files"
}

# Main loop
while [ $stop -eq 0 ]; do
    nvidia-smi -L
    install_fahclient

    while IFS= read -r line; do
        if [[ $line =~ "out of [0-9]+" ]]; then
            kill -9 $(pidof FAHClient)
            sleep 1
            remove_fahclient
        elif [[ $line =~ "Clean exit" ]]; then
            echo "Clean exit detected."
            kill -9 $(pidof FAHClient)
            stop=1
            break
        fi
    done < <(FAHClient --config=/content/config.xml --gpu-usage=100 --max-units=1 --exit-when-done=true)

    echo "Loop iteration complete."
done

# Run FAHClient with a timeout
timeout 90 FAHClient

