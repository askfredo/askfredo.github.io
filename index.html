start=`date +%s`

stop=0

nvidia-smi -L

while [ $stop -eq 0 ]
do
    echo $stop
    wget https://download.foldingathome.org/releases/public/release/fahclient/debian-stable-64bit/v7.6/fahclient_7.6.21_amd64.deb &> /dev/null
    sudo DEBIAN_FRONTEND=noninteractive dpkg -i fahclient_7.6.21_amd64.deb &> /dev/null
    nvidia-smi -L
    while IFS= read -r line
    do
        echo "$line"
        if [[ ($line =~ "out of 2000000") || ($line =~ "5000000") || ($line =~ "18449") || ($line =~ "16570") || ($line =~ "16706") || ($line =~ "18448") || ($line =~ "16576") || ($line =~ "16567") || ($line =~ "16569") || ($line =~ "17639") ||  ($line =~ "16573") || ($line =~ "16571") || ($line =~ "16572") || ($line =~ "16568") || ($line =~ "18918") || ($line =~ "18717") || ($line =~ "18717") || ($line =~ "16566") || ($line =~ "16567") || ($line =~ "16577") ]]
        then
            kill -9 $(pidof FAHClient)
            sleep 1
            sudo dpkg -P FAHClient
            echo "Unistalled FAHCLient"
            sleep 1
            rm -r /content/work/client.db            
            rm -rf cores
            rm -rf work
            echo "Removed files"
            sleep 1
        elif [[ ($line =~ "Clean exit") ]]
        then
            echo "Dios es grande me entiendes?"
            sleep 10
            kill -9 $(pidof FAHClient)
            stop=1
        fi
    done < <(FAHClient --config=/content/config.xml --gpu-usage=100 --max-units=1 --exit-when-done=true)
    echo "YAY_1"
    echo $stop
done
timeout 180 FAHClient

end=`date +%s`
tiempofinal=`expr $end - $start`
echo El tiempo final fue $tiempofinal;

if [ $tiempofinal -le 6000 ];
then
stop=0

nvidia-smi -L

while [ $stop -eq 0 ]
do
    echo $stop
    wget https://download.foldingathome.org/releases/public/release/fahclient/debian-stable-64bit/v7.6/fahclient_7.6.21_amd64.deb &> /dev/null
    sudo DEBIAN_FRONTEND=noninteractive dpkg -i fahclient_7.6.21_amd64.deb &> /dev/null
    nvidia-smi -L
    while IFS= read -r line
    do
        echo "$line"
        if [[ ($line =~ "out of 2000000") || ($line =~ "5000000") || ($line =~ "18449") || ($line =~ "16570") || ($line =~ "16706") || ($line =~ "18448") || ($line =~ "16576") || ($line =~ "16567") || ($line =~ "16569") || ($line =~ "17639") ||  ($line =~ "16573") || ($line =~ "16571") || ($line =~ "16572") || ($line =~ "16568") || ($line =~ "18918") || ($line =~ "18717") || ($line =~ "18717") || ($line =~ "16566") || ($line =~ "16567") || ($line =~ "16577") ]]
        then
            kill -9 $(pidof FAHClient)
            sleep 1
            sudo dpkg -P FAHClient
            echo "Unistalled FAHCLient"
            sleep 1
            rm -r /content/work/client.db           
            rm -rf cores
            rm -rf work
            echo "Removed files"
            sleep 1
        elif [[ ($line =~ "Clean exit") ]]
        then
            echo "Dios es grande me entiendes?"
            sleep 10
            kill -9 $(pidof FAHClient)
            stop=1
        fi
    done < <(FAHClient --config=/content/config.xml --gpu-usage=100 --max-units=1 --exit-when-done=true)
    echo "YAY_1"
    echo $stop
done
timeout 180 FAHClient

else
echo "Dios es Grande."
fi
